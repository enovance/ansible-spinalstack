Ansible Spinal Stack
====================

This playbook aims to deploy a SpinalStack platform on a libvirt hypervisor.

Prerequisite
------------

## RHEL

On a vanilla EL7 platform the following packages are necessary:

  * genisoimage
  * ansible
  * libvirt-python
  * qemu-kvm

*Note*: For qemu-kvm to be in the right path for ansible execution run `ln -s /usr/libexec/qemu-kvm /usr/bin/qemu-kvm`

## Fedora

On a Fedora 21 platform, you need the same packages and to remove firewalld:

    sudo service iptables save
    sudo systemctl disable firewalld
    sudo systemctl enable iptables
    sudo systemctl stop firewalld
    sudo systemctl start iptables

    yum remove firewalld

## Debian

The tool is know to work on Debian 7 too. In this case, you will need some
packages from wheezy-backports (qemu and libvirt-bin). You will also need to install
the python-paramiko package by yourself.

## NTP

Make sure the ntp daemon is running on the host machine as the guests will take time from it

## sudo and user account

You will need a standard user account on the libvirt machine. This use must be able to call sudo
without password:

    cat /etc/sudoers.d/myuser
    myuser  ALL=(ALL)       NOPASSWD: ALL

This user must have an ssh key with no password. You can create it with the following command:

    ssh-keygen

You need also a SSH key on your machine. We expect the public key to be in the standard
`~/.ssh/id_rsa.pub` file.

## eDeploy

For ansible-spinalstack to work one needs to retrieve two eDeploy images. The install-server and openstack-full roles.

Currently, there is an issue with the qcow2 images so one should retrieve the raw image and convert it to a qcow2 image.

```
qemu-img convert -f raw -o qcow2 myimage.img myimage.qcow2
```

Run it
------

First, edit the hosts file and configure the `ansible_ssh_host` for the hypervisor.

Then you can run the following command from your machine to be up and running :

    $ ansible-playbook -i hosts site.yml

New virtual machines will be created at every run and your `~/.ssh/known_hosts` will quickly
be outdate. The `ansible.cfg` comes with the following line: `host_key_checking = False` to
disable SSH host checking.

Tips
----

## Access to the machines from your host

    ssh -F ssh.config openstack1

`ssh.config` is an autogenerated file.

ToDo
----

* Templatize the libvirt xml description domain file
* Create a wrapper that would handler any architecture (ie. an n number of openstackfull images)
